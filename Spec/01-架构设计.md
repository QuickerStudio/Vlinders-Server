# Vlinders-Server æ¶æ„è®¾è®¡

**ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2026-02-28
**æ–‡æ¡£ç±»å‹**: æ¶æ„è®¾è®¡

---

## ğŸ“‹ æ–‡æ¡£æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†æè¿° Vlinders-Server çš„æ•´ä½“æ¶æ„è®¾è®¡ï¼ŒåŒ…æ‹¬ç³»ç»Ÿåˆ†å±‚ã€æ ¸å¿ƒç»„ä»¶ã€æ•°æ®æµã€æ‰©å±•æ€§è®¾è®¡ç­‰ã€‚

---

## ğŸ¯ æ¶æ„å®šä½

### æ ¸å¿ƒå®šä½

> **æ¨ç†å±‚ + Agent ç¼–æ’å¼•æ“**
>
> Vlinders-Server æ˜¯æ•´ä¸ª Vlinders ç”Ÿæ€ç³»ç»Ÿçš„"å¤§è„‘"ï¼Œè´Ÿè´£æ‰€æœ‰ AI ç›¸å…³çš„æ ¸å¿ƒé€»è¾‘ã€‚

### è®¾è®¡åŸåˆ™

1. **é«˜æ€§èƒ½** - åŸºäº vLLMï¼Œå……åˆ†åˆ©ç”¨ GPU èµ„æº
2. **å¯æ‰©å±•** - æ”¯æŒæ°´å¹³æ‰©å±•ï¼Œæ¨¡å—åŒ–è®¾è®¡
3. **å†…éƒ¨æœåŠ¡** - ä¸ç›´æ¥æš´éœ²ç»™ç”¨æˆ·ï¼Œåªæ¥å— Vlinders-API çš„è¯·æ±‚
4. **ä¸“æ³¨æ¨ç†** - ä¸å¤„ç†è®¤è¯ã€è®¡è´¹ç­‰ä¸šåŠ¡é€»è¾‘

---

## ğŸ—ï¸ æ•´ä½“æ¶æ„

### ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Vlinders-Server                               â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚              API Gateway Layer                          â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚
â”‚  â”‚  â”‚ FastAPI      â”‚  â”‚ gRPC Server  â”‚  â”‚ Health Check â”‚ â”‚    â”‚
â”‚  â”‚  â”‚ /internal/*  â”‚  â”‚              â”‚  â”‚ /health      â”‚ â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                           â†“                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚           Business Logic Layer                          â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â”‚  â”‚         Agent Orchestrator (æ ¸å¿ƒ)                â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  - Agent ç”Ÿå‘½å‘¨æœŸç®¡ç†                            â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  - å·¥å…·è°ƒç”¨å¾ªç¯ (Tool Calling Loop)             â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  - å­ Agent å¹¶è¡Œæ‰§è¡Œ                            â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  - ä¸Šä¸‹æ–‡ç®¡ç†å’Œå‹ç¼©                             â”‚  â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚         â†“              â†“              â†“              â†“          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚              Service Layer                              â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”â”‚    â”‚
â”‚  â”‚  â”‚  vLLM    â”‚  â”‚  Tool    â”‚  â”‚  Code    â”‚  â”‚Context â”‚â”‚    â”‚
â”‚  â”‚  â”‚Inference â”‚  â”‚ Executor â”‚  â”‚ Analysis â”‚  â”‚Manager â”‚â”‚    â”‚
â”‚  â”‚  â”‚ Service  â”‚  â”‚          â”‚  â”‚  Engine  â”‚  â”‚        â”‚â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚         â†“              â†“              â†“              â†“          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚           Infrastructure Layer                          â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”â”‚    â”‚
â”‚  â”‚  â”‚   GPU    â”‚  â”‚ Sandbox  â”‚  â”‚Tree-sitterâ”‚ â”‚ Redis  â”‚â”‚    â”‚
â”‚  â”‚  â”‚ Cluster  â”‚  â”‚ Runtime  â”‚  â”‚  Parser  â”‚  â”‚ Cache  â”‚â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚              Data Layer                                 â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚    â”‚
â”‚  â”‚  â”‚  Qdrant  â”‚  â”‚PostgreSQLâ”‚  â”‚  Redis   â”‚             â”‚    â”‚
â”‚  â”‚  â”‚ (Vector) â”‚  â”‚(Metadata)â”‚  â”‚ (Cache)  â”‚             â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“¦ åˆ†å±‚æ¶æ„è¯¦è§£

### 1. API Gateway Layerï¼ˆAPI ç½‘å…³å±‚ï¼‰

**èŒè´£**:
- æ¥æ”¶æ¥è‡ª Vlinders-API çš„å†…éƒ¨è¯·æ±‚
- è¯·æ±‚éªŒè¯å’Œè·¯ç”±
- å¥åº·æ£€æŸ¥å’Œç›‘æ§ç«¯ç‚¹

**æŠ€æœ¯é€‰å‹**:
- FastAPIï¼ˆHTTP æ¥å£ï¼‰
- gRPCï¼ˆé«˜æ€§èƒ½å†…éƒ¨é€šä¿¡ï¼‰

**å…³é”®ç«¯ç‚¹**:
```python
# HTTP ç«¯ç‚¹
POST /internal/chat              # èŠå¤©æ¨ç†
POST /internal/agent             # Agent æ‰§è¡Œ
POST /internal/tools/execute     # å·¥å…·æ‰§è¡Œ
POST /internal/embeddings        # æ–‡æœ¬åµŒå…¥
GET  /health                     # å¥åº·æ£€æŸ¥
GET  /metrics                    # Prometheus æŒ‡æ ‡

# gRPC æœåŠ¡
service InferenceService {
  rpc Chat(ChatRequest) returns (stream ChatResponse);
  rpc RunAgent(AgentRequest) returns (AgentResponse);
  rpc ExecuteTool(ToolRequest) returns (ToolResponse);
}
```

**å®‰å…¨æœºåˆ¶**:
```python
# å†…éƒ¨è®¤è¯
def verify_internal_auth(x_internal_auth: str = Header(...)):
    if x_internal_auth != INTERNAL_SECRET:
        raise HTTPException(status_code=403, detail="Forbidden")
```

---

### 2. Business Logic Layerï¼ˆä¸šåŠ¡é€»è¾‘å±‚ï¼‰

**æ ¸å¿ƒç»„ä»¶**: Agent Orchestrator

**èŒè´£**:
- ç®¡ç† Agent çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸ
- æ‰§è¡Œå·¥å…·è°ƒç”¨å¾ªç¯
- åè°ƒå­ Agent å¹¶è¡Œæ‰§è¡Œ
- ç®¡ç†å¯¹è¯ä¸Šä¸‹æ–‡

**æ¶æ„æ¨¡å¼**: äº‹ä»¶é©±åŠ¨ + çŠ¶æ€æœº

```python
class AgentOrchestrator:
    """Agent ç¼–æ’å™¨ - æ ¸å¿ƒä¸šåŠ¡é€»è¾‘"""

    def __init__(
        self,
        inference_service: VLLMInferenceService,
        tool_executor: ToolExecutor,
        context_manager: ContextManager,
        code_analyzer: CodeAnalysisEngine
    ):
        self.inference = inference_service
        self.tools = tool_executor
        self.context = context_manager
        self.code_analyzer = code_analyzer
        self.agent_registry = AgentRegistry()

    async def run_agent(
        self,
        agent_type: str,
        instruction: str,
        context: Dict[str, Any],
        config: Optional[AgentConfig] = None
    ) -> AgentResult:
        """
        è¿è¡Œ Agent çš„ä¸»å…¥å£

        æ‰§è¡Œæµç¨‹:
        1. åˆ›å»º Agent ä¸Šä¸‹æ–‡
        2. é€‰æ‹©åˆé€‚çš„æ¨¡å‹
        3. æ‰§è¡Œå·¥å…·è°ƒç”¨å¾ªç¯
        4. å¤„ç†å­ Agent è°ƒç”¨
        5. å‹ç¼©ä¸Šä¸‹æ–‡ï¼ˆå¦‚éœ€è¦ï¼‰
        6. è¿”å›ç»“æœ
        """
        # å®ç°ç»†èŠ‚è§åç»­ç« èŠ‚
```

**å·¥å…·è°ƒç”¨å¾ªç¯**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Tool Calling Loop                          â”‚
â”‚                                                         â”‚
â”‚  1. æ„å»º Prompt                                         â”‚
â”‚     â†“                                                   â”‚
â”‚  2. è°ƒç”¨ vLLM æ¨ç†                                      â”‚
â”‚     â†“                                                   â”‚
â”‚  3. è§£æå“åº”                                            â”‚
â”‚     â†“                                                   â”‚
â”‚  4. æå–å·¥å…·è°ƒç”¨                                        â”‚
â”‚     â†“                                                   â”‚
â”‚  5. å¹¶è¡Œæ‰§è¡Œå·¥å…·                                        â”‚
â”‚     â†“                                                   â”‚
â”‚  6. æ”¶é›†å·¥å…·ç»“æœ                                        â”‚
â”‚     â†“                                                   â”‚
â”‚  7. æ›´æ–°ä¸Šä¸‹æ–‡                                          â”‚
â”‚     â†“                                                   â”‚
â”‚  8. åˆ¤æ–­æ˜¯å¦ç»§ç»­ â”€â”€â†’ æ˜¯ â”€â”€â†’ å›åˆ°æ­¥éª¤ 1                 â”‚
â”‚     â†“ å¦                                                â”‚
â”‚  9. è¿”å›æœ€ç»ˆç»“æœ                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 3. Service Layerï¼ˆæœåŠ¡å±‚ï¼‰

#### 3.1 vLLM Inference Service

**èŒè´£**: å¤§æ¨¡å‹æ¨ç†

**æ ¸å¿ƒç‰¹æ€§**:
- å¤šæ¨¡å‹ç®¡ç†
- æµå¼ç”Ÿæˆ
- æ‰¹å¤„ç†ä¼˜åŒ–
- GPU èµ„æºç®¡ç†

**æ¶æ„è®¾è®¡**:
```python
class VLLMInferenceService:
    """vLLM æ¨ç†æœåŠ¡"""

    def __init__(self):
        self.engines: Dict[str, AsyncLLMEngine] = {}
        self.model_configs: Dict[str, ModelConfig] = {}
        self.request_queue = asyncio.Queue()

    async def load_model(
        self,
        model_name: str,
        model_path: str,
        tensor_parallel_size: int = 1
    ):
        """åŠ è½½æ¨¡å‹åˆ° vLLM"""
        # ä½¿ç”¨ AsyncLLMEngine æ”¯æŒå¼‚æ­¥æ¨ç†
        # é…ç½® Tensor Parallelism æ”¯æŒå¤š GPU

    async def generate(
        self,
        model: str,
        prompt: str,
        stream: bool = False
    ):
        """ç”Ÿæˆæ–‡æœ¬"""
        # æ”¯æŒæµå¼å’Œéæµå¼
        # è‡ªåŠ¨æ‰¹å¤„ç†ä¼˜åŒ–
```

#### 3.2 Tool Executor

**èŒè´£**: å·¥å…·æ‰§è¡Œå’Œç®¡ç†

**è®¾è®¡æ¨¡å¼**: æ³¨å†Œè¡¨æ¨¡å¼ + æ²™ç®±éš”ç¦»

```python
class ToolExecutor:
    """å·¥å…·æ‰§è¡Œå™¨"""

    def __init__(self, sandbox: Sandbox):
        self.tools: Dict[str, Tool] = {}
        self.sandbox = sandbox

    async def execute(
        self,
        tool_name: str,
        arguments: Dict[str, Any]
    ) -> ToolResult:
        """åœ¨æ²™ç®±ä¸­æ‰§è¡Œå·¥å…·"""
        # 1. éªŒè¯å‚æ•°
        # 2. æ£€æŸ¥æƒé™
        # 3. æ²™ç®±æ‰§è¡Œ
        # 4. è¿”å›ç»“æœ

    async def execute_batch(
        self,
        tool_calls: List[ToolCall]
    ) -> List[ToolResult]:
        """å¹¶è¡Œæ‰§è¡Œå¤šä¸ªå·¥å…·"""
        # ä½¿ç”¨ asyncio.gather å¹¶è¡Œæ‰§è¡Œ
```

**å†…ç½®å·¥å…·**:
- `search_code` - ä»£ç æœç´¢
- `semantic_search` - è¯­ä¹‰æœç´¢
- `read_file` - æ–‡ä»¶è¯»å–
- `analyze_code` - ä»£ç åˆ†æ
- `web_search` - Web æœç´¢

#### 3.3 Code Analysis Engine

**èŒè´£**: ä»£ç è§£æå’Œåˆ†æ

**æŠ€æœ¯**: Tree-sitter

```python
class CodeAnalysisEngine:
    """ä»£ç åˆ†æå¼•æ“"""

    def __init__(self):
        self.parsers: Dict[str, Parser] = {}
        self.init_parsers()

    def parse_file(
        self,
        code: str,
        language: str
    ) -> SyntaxTree:
        """è§£æä»£ç æ–‡ä»¶"""
        # ä½¿ç”¨ Tree-sitter è§£æ

    def extract_symbols(
        self,
        tree: SyntaxTree
    ) -> List[Symbol]:
        """æå–ç¬¦å·ï¼ˆå‡½æ•°ã€ç±»ã€å˜é‡ï¼‰"""
        # éå† AST æå–ç¬¦å·

    def analyze_dependencies(
        self,
        tree: SyntaxTree
    ) -> List[Dependency]:
        """åˆ†æä¾èµ–å…³ç³»"""
```

#### 3.4 Context Manager

**èŒè´£**: ä¸Šä¸‹æ–‡ç®¡ç†å’Œå‹ç¼©

**æ ¸å¿ƒåŠŸèƒ½**:
- å¯¹è¯å†å²ç®¡ç†
- åå°å‹ç¼©
- Token é¢„ç®—ç®¡ç†
- Memory æœåŠ¡

```python
class ContextManager:
    """ä¸Šä¸‹æ–‡ç®¡ç†å™¨"""

    async def create_context(
        self,
        agent_type: str,
        instruction: str,
        workspace: str,
        history: List[Message]
    ) -> AgentContext:
        """åˆ›å»º Agent ä¸Šä¸‹æ–‡"""

    async def compress_background(
        self,
        context: AgentContext
    ) -> CompressionResult:
        """åå°å‹ç¼©å¯¹è¯å†å²"""
        # ä½¿ç”¨å°æ¨¡å‹ç”Ÿæˆæ‘˜è¦
        # æ›¿æ¢åŸå§‹å†…å®¹
        # èŠ‚çœ Token

    def should_compress(
        self,
        context: AgentContext
    ) -> bool:
        """åˆ¤æ–­æ˜¯å¦éœ€è¦å‹ç¼©"""
        # Token ä½¿ç”¨ç‡ >= 75% æ—¶è§¦å‘
```

---

### 4. Infrastructure Layerï¼ˆåŸºç¡€è®¾æ–½å±‚ï¼‰

#### 4.1 GPU Cluster

**é…ç½®**:
- NVIDIA A100/H100
- CUDA 12.0+
- Tensor Parallelism æ”¯æŒ

**èµ„æºç®¡ç†**:
```python
class GPUResourceManager:
    """GPU èµ„æºç®¡ç†å™¨"""

    def allocate_gpu(
        self,
        model_name: str,
        required_gpus: int
    ) -> List[int]:
        """åˆ†é… GPU èµ„æº"""

    def monitor_usage(self) -> GPUUsage:
        """ç›‘æ§ GPU ä½¿ç”¨æƒ…å†µ"""
```

#### 4.2 Sandbox Runtime

**æŠ€æœ¯**: Docker + seccomp

**éš”ç¦»çº§åˆ«**:
- æ–‡ä»¶ç³»ç»Ÿéš”ç¦»
- ç½‘ç»œéš”ç¦»
- èµ„æºé™åˆ¶ï¼ˆCPUã€å†…å­˜ã€æ—¶é—´ï¼‰

```python
class Sandbox:
    """æ²™ç®±è¿è¡Œæ—¶"""

    async def execute(
        self,
        tool: Tool,
        arguments: Dict[str, Any],
        timeout: int = 30
    ) -> ExecutionResult:
        """åœ¨æ²™ç®±ä¸­æ‰§è¡Œå·¥å…·"""
        # ä½¿ç”¨ Docker å®¹å™¨éš”ç¦»
        # è®¾ç½®èµ„æºé™åˆ¶
        # è¶…æ—¶æ§åˆ¶
```

---

### 5. Data Layerï¼ˆæ•°æ®å±‚ï¼‰

#### 5.1 Qdrantï¼ˆå‘é‡æ•°æ®åº“ï¼‰

**ç”¨é€”**:
- ä»£ç åµŒå…¥å­˜å‚¨
- è¯­ä¹‰æœç´¢
- ç›¸ä¼¼åº¦åŒ¹é…

**Schema**:
```python
# Collection: code_embeddings
{
    "id": "file_path:line_range",
    "vector": [0.1, 0.2, ...],  # 768 ç»´
    "payload": {
        "file_path": "/path/to/file.py",
        "language": "python",
        "code": "def fibonacci(n): ...",
        "symbols": ["fibonacci"],
        "start_line": 10,
        "end_line": 15
    }
}
```

#### 5.2 PostgreSQLï¼ˆå…ƒæ•°æ®ï¼‰

**ç”¨é€”**:
- Agent æ‰§è¡Œæ—¥å¿—
- å·¥å…·è°ƒç”¨è®°å½•
- æ€§èƒ½æŒ‡æ ‡

**Schema**:
```sql
-- Agent æ‰§è¡Œæ—¥å¿—
CREATE TABLE agent_executions (
    id UUID PRIMARY KEY,
    agent_type VARCHAR(50) NOT NULL,
    user_id VARCHAR(100),
    instruction TEXT NOT NULL,
    iterations INTEGER NOT NULL,
    duration_ms INTEGER NOT NULL,
    tokens_used INTEGER NOT NULL,
    created_at TIMESTAMP NOT NULL
);

-- å·¥å…·è°ƒç”¨è®°å½•
CREATE TABLE tool_calls (
    id UUID PRIMARY KEY,
    agent_execution_id UUID REFERENCES agent_executions(id),
    tool_name VARCHAR(100) NOT NULL,
    arguments JSONB NOT NULL,
    result JSONB,
    duration_ms INTEGER NOT NULL,
    success BOOLEAN NOT NULL,
    created_at TIMESTAMP NOT NULL
);
```

#### 5.3 Redisï¼ˆç¼“å­˜ï¼‰

**ç”¨é€”**:
- æ¨ç†ç»“æœç¼“å­˜
- å·¥å…·ç»“æœç¼“å­˜
- åˆ†å¸ƒå¼é”

**ç¼“å­˜ç­–ç•¥**:
```python
# æ¨ç†ç»“æœç¼“å­˜
cache_key = f"inference:{hash(prompt)}"
ttl = 3600  # 1 å°æ—¶

# å·¥å…·ç»“æœç¼“å­˜
cache_key = f"tool:{tool_name}:{hash(arguments)}"
ttl = 300  # 5 åˆ†é’Ÿ
```

---

## ğŸ”„ æ•°æ®æµè®¾è®¡

### å®Œæ•´è¯·æ±‚æµç¨‹

```
1. Vlinders-API å‘é€è¯·æ±‚
   POST /internal/chat
   Headers: X-Internal-Auth: <secret>
   Body: {model, messages, tools, user_id}
   â†“
2. API Gateway éªŒè¯å†…éƒ¨è®¤è¯
   â†“
3. è·¯ç”±åˆ° Agent Orchestrator
   â†“
4. åˆ›å»º Agent ä¸Šä¸‹æ–‡
   - åŠ è½½å†å²å¯¹è¯
   - åˆå§‹åŒ–å·¥å…·åˆ—è¡¨
   - è®¾ç½® Token é¢„ç®—
   â†“
5. å·¥å…·è°ƒç”¨å¾ªç¯å¼€å§‹
   â†“
6. æ„å»º Prompt
   - ç³»ç»ŸæŒ‡ä»¤
   - å¯¹è¯å†å²
   - å¯ç”¨å·¥å…·åˆ—è¡¨
   - å½“å‰æŒ‡ä»¤
   â†“
7. vLLM æ¨ç†
   - é€‰æ‹©æ¨¡å‹
   - ç”Ÿæˆå“åº”
   - è§£æå·¥å…·è°ƒç”¨
   â†“
8. æ‰§è¡Œå·¥å…·ï¼ˆå¹¶è¡Œï¼‰
   - search_code
   - read_file
   - analyze_code
   â†“
9. æ”¶é›†å·¥å…·ç»“æœ
   â†“
10. æ›´æ–°ä¸Šä¸‹æ–‡
    â†“
11. åˆ¤æ–­æ˜¯å¦ç»§ç»­
    - æœ‰å·¥å…·è°ƒç”¨ â†’ å›åˆ°æ­¥éª¤ 6
    - æ— å·¥å…·è°ƒç”¨ â†’ ç»§ç»­
    â†“
12. æ£€æŸ¥ä¸Šä¸‹æ–‡å¤§å°
    - è¶…è¿‡é˜ˆå€¼ â†’ åå°å‹ç¼©
    â†“
13. è¿”å›æœ€ç»ˆç»“æœ
    {
      response: "...",
      tool_calls: [...],
      iterations: 3,
      usage: {tokens: 1000}
    }
    â†“
14. è®°å½•æ—¥å¿—åˆ° PostgreSQL
    â†“
15. è¿”å›ç»™ Vlinders-API
```

---

## ğŸš€ æ‰©å±•æ€§è®¾è®¡

### æ°´å¹³æ‰©å±•

**æ¶æ„**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Load        â”‚
â”‚ Balancer    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â†“         â†“         â†“         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Server 1 â”‚ â”‚ Server 2 â”‚ â”‚ Server N â”‚
â”‚ (4 GPUs) â”‚ â”‚ (4 GPUs) â”‚ â”‚ (4 GPUs) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚         â”‚         â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Shared Redis  â”‚
         â”‚ Shared Qdrant â”‚
         â”‚ Shared PG     â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ— çŠ¶æ€è®¾è®¡**:
- æ‰€æœ‰çŠ¶æ€å­˜å‚¨åœ¨ Redis/PostgreSQL
- ä»»ä½•æœåŠ¡å™¨éƒ½å¯ä»¥å¤„ç†ä»»ä½•è¯·æ±‚
- æ”¯æŒåŠ¨æ€æ‰©ç¼©å®¹

### æ¨¡å‹çƒ­åŠ è½½

```python
class ModelManager:
    """æ¨¡å‹ç®¡ç†å™¨"""

    async def load_model_async(
        self,
        model_name: str,
        model_path: str
    ):
        """å¼‚æ­¥åŠ è½½æ¨¡å‹ï¼Œä¸é˜»å¡ç°æœ‰è¯·æ±‚"""

    async def unload_model(
        self,
        model_name: str
    ):
        """å¸è½½æ¨¡å‹ï¼Œé‡Šæ”¾ GPU å†…å­˜"""

    async def switch_model(
        self,
        old_model: str,
        new_model: str
    ):
        """å¹³æ»‘åˆ‡æ¢æ¨¡å‹"""
        # 1. åŠ è½½æ–°æ¨¡å‹
        # 2. ç­‰å¾…ç°æœ‰è¯·æ±‚å®Œæˆ
        # 3. å¸è½½æ—§æ¨¡å‹
```

### æ’ä»¶ç³»ç»Ÿ

```python
class PluginRegistry:
    """æ’ä»¶æ³¨å†Œè¡¨"""

    def register_tool(
        self,
        tool: Tool
    ):
        """æ³¨å†Œè‡ªå®šä¹‰å·¥å…·"""

    def register_agent(
        self,
        agent_type: str,
        agent_class: Type[Agent]
    ):
        """æ³¨å†Œè‡ªå®šä¹‰ Agent"""
```

---

## ğŸ“Š æ€§èƒ½è®¾è®¡

### å¹¶å‘å¤„ç†

**ç›®æ ‡**:
- æ”¯æŒ 100+ å¹¶å‘è¯·æ±‚
- GPU åˆ©ç”¨ç‡ > 80%
- å¹³å‡å“åº”æ—¶é—´ < 2s

**ç­–ç•¥**:
1. **å¼‚æ­¥ I/O** - ä½¿ç”¨ asyncio
2. **è¿ç»­æ‰¹å¤„ç†** - vLLM è‡ªåŠ¨æ‰¹å¤„ç†
3. **è¿æ¥æ± ** - æ•°æ®åº“è¿æ¥æ± 
4. **ç¼“å­˜** - å¤šå±‚ç¼“å­˜ç­–ç•¥

### ç¼“å­˜ç­–ç•¥

```python
# L1: å†…å­˜ç¼“å­˜ï¼ˆè¿›ç¨‹å†…ï¼‰
memory_cache = {}

# L2: Redis ç¼“å­˜ï¼ˆåˆ†å¸ƒå¼ï¼‰
redis_cache = Redis()

# L3: æ•°æ®åº“ï¼ˆæŒä¹…åŒ–ï¼‰
database = PostgreSQL()

async def get_with_cache(key: str):
    # 1. æ£€æŸ¥å†…å­˜ç¼“å­˜
    if key in memory_cache:
        return memory_cache[key]

    # 2. æ£€æŸ¥ Redis
    value = await redis_cache.get(key)
    if value:
        memory_cache[key] = value
        return value

    # 3. æŸ¥è¯¢æ•°æ®åº“
    value = await database.query(key)
    if value:
        await redis_cache.set(key, value, ttl=3600)
        memory_cache[key] = value
        return value

    return None
```

### èµ„æºç®¡ç†

```python
class ResourceManager:
    """èµ„æºç®¡ç†å™¨"""

    def __init__(self):
        self.gpu_semaphore = asyncio.Semaphore(4)  # 4 ä¸ª GPU
        self.memory_limit = 90 * 1024 * 1024 * 1024  # 90GB

    async def acquire_resources(
        self,
        required_memory: int
    ):
        """è·å–èµ„æº"""
        async with self.gpu_semaphore:
            if self.current_memory + required_memory > self.memory_limit:
                await self.wait_for_memory()
            yield
```

---

## ğŸ” ç›‘æ§å’Œå¯è§‚æµ‹æ€§

### Prometheus æŒ‡æ ‡

```python
from prometheus_client import Counter, Histogram, Gauge

# è¯·æ±‚è®¡æ•°
request_count = Counter(
    'vlinders_requests_total',
    'Total requests',
    ['endpoint', 'status']
)

# å“åº”æ—¶é—´
response_time = Histogram(
    'vlinders_response_seconds',
    'Response time',
    ['endpoint']
)

# GPU ä½¿ç”¨ç‡
gpu_utilization = Gauge(
    'vlinders_gpu_utilization',
    'GPU utilization',
    ['gpu_id']
)

# Token ä½¿ç”¨é‡
tokens_used = Counter(
    'vlinders_tokens_total',
    'Total tokens used',
    ['model']
)
```

### OpenTelemetry è¿½è¸ª

```python
from opentelemetry import trace

tracer = trace.get_tracer(__name__)

async def run_agent(request):
    with tracer.start_as_current_span("run_agent") as span:
        span.set_attribute("agent_type", request.agent_type)

        with tracer.start_as_current_span("tool_calling_loop"):
            # å·¥å…·è°ƒç”¨å¾ªç¯

        with tracer.start_as_current_span("vllm_inference"):
            # vLLM æ¨ç†

        return result
```

---

## ğŸ“ å…³é”®è®¾è®¡å†³ç­–

### 1. ä¸ºä»€ä¹ˆé€‰æ‹© vLLMï¼Ÿ

**å¯¹æ¯”**:
| ç‰¹æ€§ | vLLM | TGI | vLLM-alternatives |
|------|------|-----|-------------------|
| æ€§èƒ½ | â­â­â­â­â­ | â­â­â­â­ | â­â­â­ |
| æ˜“ç”¨æ€§ | â­â­â­â­â­ | â­â­â­ | â­â­â­â­ |
| ç¤¾åŒº | â­â­â­â­â­ | â­â­â­â­ | â­â­â­ |
| æ–‡æ¡£ | â­â­â­â­â­ | â­â­â­â­ | â­â­â­ |

**é€‰æ‹©ç†ç”±**:
- PagedAttention æŠ€æœ¯ï¼Œæ˜¾è‘—æå‡ååé‡
- Continuous Batchingï¼Œè‡ªåŠ¨ä¼˜åŒ–æ‰¹å¤„ç†
- æ´»è·ƒçš„ç¤¾åŒºå’Œå®Œå–„çš„æ–‡æ¡£
- æ”¯æŒå¤šç§æ¨¡å‹æ ¼å¼

### 2. ä¸ºä»€ä¹ˆé€‰æ‹© FastAPIï¼Ÿ

- å¼‚æ­¥æ”¯æŒï¼ˆasyncioï¼‰
- è‡ªåŠ¨ API æ–‡æ¡£ï¼ˆOpenAPIï¼‰
- ç±»å‹æ£€æŸ¥ï¼ˆPydanticï¼‰
- é«˜æ€§èƒ½ï¼ˆStarlette + Uvicornï¼‰

### 3. ä¸ºä»€ä¹ˆé€‰æ‹© Qdrantï¼Ÿ

- å¼€æºä¸”åŠŸèƒ½å®Œæ•´
- é«˜æ€§èƒ½å‘é‡æœç´¢
- æ”¯æŒè¿‡æ»¤å’Œæ··åˆæœç´¢
- æ˜“äºéƒ¨ç½²å’Œç»´æŠ¤

---

## ğŸ¯ æ€»ç»“

Vlinders-Server çš„æ¶æ„è®¾è®¡éµå¾ªä»¥ä¸‹åŸåˆ™ï¼š

1. **åˆ†å±‚æ¸…æ™°** - APIã€ä¸šåŠ¡ã€æœåŠ¡ã€åŸºç¡€è®¾æ–½ã€æ•°æ®äº”å±‚
2. **é«˜æ€§èƒ½** - åŸºäº vLLMï¼Œå……åˆ†åˆ©ç”¨ GPU
3. **å¯æ‰©å±•** - æ— çŠ¶æ€è®¾è®¡ï¼Œæ”¯æŒæ°´å¹³æ‰©å±•
4. **å¯è§‚æµ‹** - å®Œå–„çš„ç›‘æ§å’Œè¿½è¸ª
5. **ä¸“æ³¨æ ¸å¿ƒ** - åªåšæ¨ç†å’Œ Agent ç¼–æ’

---

**ä¸‹ä¸€æ­¥**: é˜…è¯» [02-æŠ€æœ¯é€‰å‹.md](./02-æŠ€æœ¯é€‰å‹.md)
