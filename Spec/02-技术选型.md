# Vlinders-Server æŠ€æœ¯é€‰å‹

**ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2026-02-28
**æ–‡æ¡£ç±»å‹**: æŠ€æœ¯é€‰å‹

---

## ğŸ“‹ æ–‡æ¡£æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜ Vlinders-Server çš„æŠ€æœ¯é€‰å‹å†³ç­–ï¼ŒåŒ…æ‹¬å„æŠ€æœ¯æ–¹æ¡ˆçš„å¯¹æ¯”ã€é€‰æ‹©ç†ç”±å’Œæ›¿ä»£æ–¹æ¡ˆã€‚

---

## ğŸ¯ é€‰å‹åŸåˆ™

1. **æ€§èƒ½ä¼˜å…ˆ** - é€‰æ‹©é«˜æ€§èƒ½çš„æŠ€æœ¯æ ˆ
2. **æˆç†Ÿç¨³å®š** - ä¼˜å…ˆé€‰æ‹©ç»è¿‡éªŒè¯çš„æŠ€æœ¯
3. **ç¤¾åŒºæ´»è·ƒ** - æœ‰æ´»è·ƒçš„ç¤¾åŒºæ”¯æŒ
4. **æ˜“äºç»´æŠ¤** - é™ä½é•¿æœŸç»´æŠ¤æˆæœ¬
5. **å¼€æºä¼˜å…ˆ** - ä¼˜å…ˆé€‰æ‹©å¼€æºæ–¹æ¡ˆ

---

## ğŸš€ æ ¸å¿ƒæŠ€æœ¯æ ˆ

### 1. æ¨ç†å¼•æ“ï¼švLLM

#### å¯¹æ¯”åˆ†æ

| ç‰¹æ€§ | vLLM | TGI (Text Generation Inference) | vLLM-alternatives |
|------|------|--------------------------------|-------------------|
| **æ€§èƒ½** | â­â­â­â­â­ | â­â­â­â­ | â­â­â­ |
| **ååé‡** | 24x (PagedAttention) | 10x | 5x |
| **å»¶è¿Ÿ** | ä½ | ä¸­ | ä¸­ |
| **GPU åˆ©ç”¨ç‡** | 90%+ | 70-80% | 60-70% |
| **æ˜“ç”¨æ€§** | â­â­â­â­â­ | â­â­â­ | â­â­â­â­ |
| **æ–‡æ¡£** | å®Œå–„ | è¾ƒå¥½ | ä¸€èˆ¬ |
| **ç¤¾åŒº** | éå¸¸æ´»è·ƒ | æ´»è·ƒ | å°ä¼— |
| **æ¨¡å‹æ”¯æŒ** | å¹¿æ³› | å¹¿æ³› | æœ‰é™ |
| **æ‰¹å¤„ç†** | Continuous Batching | Static Batching | Manual |
| **æµå¼æ”¯æŒ** | âœ… åŸç”Ÿæ”¯æŒ | âœ… æ”¯æŒ | âš ï¸ éƒ¨åˆ†æ”¯æŒ |
| **å¤š GPU** | âœ… Tensor Parallelism | âœ… æ”¯æŒ | âš ï¸ æœ‰é™ |
| **é‡åŒ–** | âœ… AWQ, GPTQ | âœ… æ”¯æŒ | âš ï¸ æœ‰é™ |
| **å¼€æº** | âœ… Apache 2.0 | âœ… Apache 2.0 | âœ… MIT |

#### æ ¸å¿ƒä¼˜åŠ¿

**1. PagedAttention**
```
ä¼ ç»Ÿæ–¹æ³•:
- é¢„åˆ†é…å›ºå®šå¤§å°çš„ KV Cache
- å†…å­˜æµªè´¹ä¸¥é‡ï¼ˆç¢ç‰‡åŒ–ï¼‰
- ååé‡å—é™

vLLM PagedAttention:
- åŠ¨æ€åˆ†é¡µç®¡ç† KV Cache
- å†…å­˜åˆ©ç”¨ç‡æå‡ 4x
- ååé‡æå‡ 24x
```

**2. Continuous Batching**
```
ä¼ ç»Ÿ Static Batching:
- ç­‰å¾…æ‰€æœ‰è¯·æ±‚å®Œæˆæ‰èƒ½å¤„ç†æ–°è¯·æ±‚
- GPU ç©ºé—²æ—¶é—´å¤š

vLLM Continuous Batching:
- è¯·æ±‚å®Œæˆåç«‹å³å¤„ç†æ–°è¯·æ±‚
- GPU åˆ©ç”¨ç‡æœ€å¤§åŒ–
- å»¶è¿Ÿé™ä½ 50%
```

**3. ä¼˜åŒ–çš„å†…æ ¸**
- CUDA å†…æ ¸ä¼˜åŒ–
- FlashAttention é›†æˆ
- é«˜æ•ˆçš„é‡‡æ ·ç®—æ³•

#### é€‰æ‹©ç†ç”±

âœ… **æ€§èƒ½æœ€ä¼˜** - 24x ååé‡æå‡
âœ… **æ˜“äºé›†æˆ** - Python API ç®€å•
âœ… **ç¤¾åŒºæ´»è·ƒ** - UC Berkeley ç»´æŠ¤
âœ… **æ–‡æ¡£å®Œå–„** - è¯¦ç»†çš„ä½¿ç”¨æŒ‡å—
âœ… **æŒç»­æ›´æ–°** - å¿«é€Ÿè¿­ä»£

#### æ›¿ä»£æ–¹æ¡ˆ

**TGI (Hugging Face)**:
- ä¼˜ç‚¹: ä¸ Hugging Face ç”Ÿæ€é›†æˆå¥½
- ç¼ºç‚¹: æ€§èƒ½ä¸å¦‚ vLLM
- é€‚ç”¨: å¦‚æœå·²æ·±åº¦ä½¿ç”¨ HF ç”Ÿæ€

**è‡ªå»ºæ¨ç†å¼•æ“**:
- ä¼˜ç‚¹: å®Œå…¨å¯æ§
- ç¼ºç‚¹: å¼€å‘æˆæœ¬æé«˜
- é€‚ç”¨: æœ‰ä¸“é—¨çš„ CUDA å›¢é˜Ÿ

---

### 1.5. è¯­ä¹‰è·¯ç”±ï¼švLLM Semantic Router

#### ç®€ä»‹

vLLM Semantic Router æ˜¯ä¸€ä¸ªæ™ºèƒ½è·¯ç”±ç»„ä»¶ï¼Œå¯ä»¥æ ¹æ®è¯·æ±‚çš„è¯­ä¹‰å†…å®¹è‡ªåŠ¨é€‰æ‹©æœ€åˆé€‚çš„æ¨¡å‹ã€‚

**å®˜ç½‘**: https://vllm-semantic-router.com/

#### æ ¸å¿ƒåŠŸèƒ½

**1. æ™ºèƒ½æ¨¡å‹é€‰æ‹©**
```python
from vllm_semantic_router import SemanticRouter

router = SemanticRouter(
    models={
        "vlinders-gpt-4": {
            "capabilities": ["complex_reasoning", "code_generation"],
            "cost": 0.03,
            "speed": "medium"
        },
        "vlinders-gpt-3.5": {
            "capabilities": ["simple_chat", "quick_completion"],
            "cost": 0.002,
            "speed": "fast"
        }
    }
)

# è‡ªåŠ¨é€‰æ‹©æœ€åˆé€‚çš„æ¨¡å‹
selected_model = router.route(
    prompt="Write a complex algorithm for graph traversal",
    requirements={"quality": "high", "cost": "medium"}
)
# è¿”å›: "vlinders-gpt-4"
```

**2. æˆæœ¬ä¼˜åŒ–**
- ç®€å•ä»»åŠ¡è‡ªåŠ¨è·¯ç”±åˆ°å°æ¨¡å‹
- å¤æ‚ä»»åŠ¡è·¯ç”±åˆ°å¤§æ¨¡å‹
- é™ä½æ•´ä½“æ¨ç†æˆæœ¬

**3. æ€§èƒ½ä¼˜åŒ–**
- æ ¹æ®è´Ÿè½½åŠ¨æ€è·¯ç”±
- é¿å…å•ä¸ªæ¨¡å‹è¿‡è½½
- æå‡æ•´ä½“ååé‡

#### ä½¿ç”¨åœºæ™¯

| åœºæ™¯ | è·¯ç”±ç­–ç•¥ |
|------|---------|
| ç®€å•ä»£ç è¡¥å…¨ | â†’ vlinders-gpt-3.5 (å¿«é€Ÿã€ä½æˆæœ¬) |
| å¤æ‚ä»£ç ç”Ÿæˆ | â†’ vlinders-gpt-4 (é«˜è´¨é‡) |
| ä»£ç è§£é‡Š | â†’ vlinders-gpt-3.5 (è¶³å¤Ÿ) |
| æ¶æ„è®¾è®¡ | â†’ vlinders-gpt-4 (éœ€è¦æ·±åº¦æ¨ç†) |
| ç®€å•é—®ç­” | â†’ vlinders-gpt-3.5 (å¿«é€Ÿå“åº”) |

#### é›†æˆæ–¹æ¡ˆ

```python
class ModelRouter:
    """æ¨¡å‹è·¯ç”±å™¨"""

    def __init__(self):
        self.semantic_router = SemanticRouter()
        self.model_manager = ModelManager()

    async def route_request(
        self,
        prompt: str,
        user_preference: Optional[str] = None
    ) -> str:
        """è·¯ç”±è¯·æ±‚åˆ°æœ€åˆé€‚çš„æ¨¡å‹"""

        # ç”¨æˆ·æŒ‡å®šæ¨¡å‹
        if user_preference:
            return user_preference

        # è¯­ä¹‰è·¯ç”±
        model = self.semantic_router.route(
            prompt=prompt,
            requirements={
                "quality": "balanced",
                "cost": "optimized"
            }
        )

        return model

    async def generate_with_routing(
        self,
        prompt: str,
        **kwargs
    ):
        """ä½¿ç”¨è·¯ç”±çš„æ¨ç†"""

        # é€‰æ‹©æ¨¡å‹
        model = await self.route_request(prompt)

        # è·å–å¼•æ“
        engine = self.model_manager.get_engine(model)

        # ç”Ÿæˆ
        result = await engine.generate(prompt, **kwargs)

        return {
            "model_used": model,
            "result": result
        }
```

#### ä¼˜åŠ¿

âœ… **æˆæœ¬èŠ‚çœ** - è‡ªåŠ¨é€‰æ‹©æ€§ä»·æ¯”æœ€é«˜çš„æ¨¡å‹
âœ… **æ€§èƒ½ä¼˜åŒ–** - è´Ÿè½½å‡è¡¡ï¼Œé¿å…è¿‡è½½
âœ… **ç”¨æˆ·ä½“éªŒ** - è‡ªåŠ¨é€‰æ‹©ï¼Œæ— éœ€æ‰‹åŠ¨æŒ‡å®š
âœ… **çµæ´»é…ç½®** - æ”¯æŒè‡ªå®šä¹‰è·¯ç”±è§„åˆ™

#### é€‰æ‹©ç†ç”±

- ä¸ vLLM æ— ç¼é›†æˆ
- é™ä½æ¨ç†æˆæœ¬ 30-50%
- æå‡ç³»ç»Ÿååé‡
- æ”¹å–„ç”¨æˆ·ä½“éªŒ

---

### 2. Web æ¡†æ¶ï¼šFastAPI

#### å¯¹æ¯”åˆ†æ

| ç‰¹æ€§ | FastAPI | Flask | Django |
|------|---------|-------|--------|
| **æ€§èƒ½** | â­â­â­â­â­ | â­â­â­ | â­â­ |
| **å¼‚æ­¥æ”¯æŒ** | âœ… åŸç”Ÿ | âš ï¸ éœ€æ’ä»¶ | âš ï¸ 3.1+ |
| **ç±»å‹æ£€æŸ¥** | âœ… Pydantic | âŒ | âŒ |
| **API æ–‡æ¡£** | âœ… è‡ªåŠ¨ç”Ÿæˆ | âŒ | âŒ |
| **å­¦ä¹ æ›²çº¿** | ä½ | ä½ | é«˜ |
| **ç”Ÿæ€** | å¿«é€Ÿå¢é•¿ | æˆç†Ÿ | éå¸¸æˆç†Ÿ |
| **é€‚ç”¨åœºæ™¯** | API æœåŠ¡ | å°å‹åº”ç”¨ | å…¨æ ˆåº”ç”¨ |

#### æ ¸å¿ƒä¼˜åŠ¿

**1. å¼‚æ­¥æ”¯æŒ**
```python
# FastAPI åŸç”Ÿå¼‚æ­¥
@app.post("/chat")
async def chat(request: ChatRequest):
    result = await vllm_service.generate(request.prompt)
    return result

# Flask éœ€è¦é¢å¤–é…ç½®
@app.route("/chat", methods=["POST"])
def chat():
    # åŒæ­¥ä»£ç ï¼Œé˜»å¡
    result = vllm_service.generate(request.json["prompt"])
    return result
```

**2. è‡ªåŠ¨ API æ–‡æ¡£**
```python
# FastAPI è‡ªåŠ¨ç”Ÿæˆ OpenAPI æ–‡æ¡£
# è®¿é—® /docs å³å¯çœ‹åˆ°äº¤äº’å¼æ–‡æ¡£
# è®¿é—® /redoc å¯çœ‹åˆ° ReDoc æ–‡æ¡£

# Flask éœ€è¦æ‰‹åŠ¨ç¼–å†™æˆ–ä½¿ç”¨ flask-swagger
```

**3. ç±»å‹æ£€æŸ¥**
```python
# FastAPI ä½¿ç”¨ Pydantic è‡ªåŠ¨éªŒè¯
class ChatRequest(BaseModel):
    model: str
    messages: List[Message]
    temperature: float = 0.7

@app.post("/chat")
async def chat(request: ChatRequest):
    # request å·²ç»éªŒè¯å’Œç±»å‹è½¬æ¢
    pass

# Flask éœ€è¦æ‰‹åŠ¨éªŒè¯
@app.route("/chat", methods=["POST"])
def chat():
    data = request.json
    if "model" not in data:
        return {"error": "model required"}, 400
    # æ‰‹åŠ¨éªŒè¯æ¯ä¸ªå­—æ®µ...
```

#### é€‰æ‹©ç†ç”±

âœ… **é«˜æ€§èƒ½** - åŸºäº Starlette å’Œ Uvicorn
âœ… **å¼‚æ­¥åŸç”Ÿ** - å®Œç¾é…åˆ vLLM çš„å¼‚æ­¥ API
âœ… **ç±»å‹å®‰å…¨** - Pydantic è‡ªåŠ¨éªŒè¯
âœ… **è‡ªåŠ¨æ–‡æ¡£** - å¼€å‘å’Œè°ƒè¯•æ–¹ä¾¿
âœ… **ç°ä»£åŒ–** - ç¬¦åˆå½“å‰æœ€ä½³å®è·µ

#### æ›¿ä»£æ–¹æ¡ˆ

**Flask**:
- ä¼˜ç‚¹: ç®€å•ã€æˆç†Ÿ
- ç¼ºç‚¹: åŒæ­¥ã€æ— ç±»å‹æ£€æŸ¥
- é€‚ç”¨: ç®€å•çš„åŒæ­¥åº”ç”¨

**Django**:
- ä¼˜ç‚¹: å…¨æ ˆæ¡†æ¶ã€ORM å¼ºå¤§
- ç¼ºç‚¹: è¿‡äºé‡é‡çº§
- é€‚ç”¨: éœ€è¦å®Œæ•´ Web åº”ç”¨

---

### 3. ä»£ç è§£æï¼šTree-sitter

#### å¯¹æ¯”åˆ†æ

| ç‰¹æ€§ | Tree-sitter | LSP (Language Server) | æ­£åˆ™è¡¨è¾¾å¼ |
|------|-------------|----------------------|-----------|
| **å‡†ç¡®æ€§** | â­â­â­â­â­ | â­â­â­â­â­ | â­â­ |
| **æ€§èƒ½** | â­â­â­â­â­ | â­â­â­ | â­â­â­â­â­ |
| **è¯­è¨€æ”¯æŒ** | 40+ | å–å†³äºå®ç° | æ‰€æœ‰ |
| **å¢é‡è§£æ** | âœ… | âœ… | âŒ |
| **é”™è¯¯æ¢å¤** | âœ… | âœ… | âŒ |
| **æ˜“ç”¨æ€§** | â­â­â­â­ | â­â­â­ | â­â­â­â­â­ |
| **éƒ¨ç½²** | ç®€å• | å¤æ‚ | ç®€å• |

#### æ ¸å¿ƒä¼˜åŠ¿

**1. å¢é‡è§£æ**
```python
# Tree-sitter æ”¯æŒå¢é‡è§£æ
tree = parser.parse(old_code)
# ä»£ç ä¿®æ”¹å
new_tree = parser.parse(new_code, old_tree)
# åªé‡æ–°è§£æä¿®æ”¹çš„éƒ¨åˆ†ï¼Œæ€§èƒ½æå‡ 10x
```

**2. é”™è¯¯æ¢å¤**
```python
# å³ä½¿ä»£ç æœ‰è¯­æ³•é”™è¯¯ï¼Œä¹Ÿèƒ½è§£æ
code = """
def fibonacci(n):
    if n <= 1:
        return n
    # ç¼ºå°‘ return è¯­å¥ï¼Œä½†ä»èƒ½è§£æ
"""
tree = parser.parse(code)
# å¯ä»¥æå–éƒ¨åˆ†ç¬¦å·
```

**3. ç»Ÿä¸€æ¥å£**
```python
# æ‰€æœ‰è¯­è¨€ä½¿ç”¨ç›¸åŒçš„ API
python_parser = get_parser("python")
js_parser = get_parser("javascript")
go_parser = get_parser("go")

# ç›¸åŒçš„æŸ¥è¯¢è¯­æ³•
query = """
(function_definition
  name: (identifier) @function.name)
"""
```

#### é€‰æ‹©ç†ç”±

âœ… **é«˜æ€§èƒ½** - C å®ç°ï¼Œé€Ÿåº¦å¿«
âœ… **å¤šè¯­è¨€** - æ”¯æŒ 40+ è¯­è¨€
âœ… **å¢é‡è§£æ** - é€‚åˆå®æ—¶åˆ†æ
âœ… **é”™è¯¯å®¹å¿** - ä¸å®Œæ•´ä»£ç ä¹Ÿèƒ½è§£æ
âœ… **æ˜“äºé›†æˆ** - Python ç»‘å®šå®Œå–„

#### æ›¿ä»£æ–¹æ¡ˆ

**LSP (Language Server Protocol)**:
- ä¼˜ç‚¹: åŠŸèƒ½æ›´å®Œæ•´ï¼ˆè·³è½¬ã€è¡¥å…¨ç­‰ï¼‰
- ç¼ºç‚¹: éœ€è¦å¯åŠ¨ç‹¬ç«‹è¿›ç¨‹ï¼Œå¤æ‚
- é€‚ç”¨: éœ€è¦å®Œæ•´ IDE åŠŸèƒ½

**æ­£åˆ™è¡¨è¾¾å¼**:
- ä¼˜ç‚¹: ç®€å•ã€å¿«é€Ÿ
- ç¼ºç‚¹: ä¸å‡†ç¡®ã€æ— æ³•å¤„ç†å¤æ‚è¯­æ³•
- é€‚ç”¨: ç®€å•çš„æ–‡æœ¬åŒ¹é…

---

### 4. å‘é‡æ•°æ®åº“ï¼šQdrant

#### å¯¹æ¯”åˆ†æ

| ç‰¹æ€§ | Qdrant | Pinecone | Milvus | Weaviate |
|------|--------|----------|--------|----------|
| **æ€§èƒ½** | â­â­â­â­â­ | â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­ |
| **å¼€æº** | âœ… Apache 2.0 | âŒ é—­æº | âœ… Apache 2.0 | âœ… BSD |
| **éƒ¨ç½²** | ç®€å• | SaaS only | å¤æ‚ | ä¸­ç­‰ |
| **è¿‡æ»¤** | â­â­â­â­â­ | â­â­â­â­ | â­â­â­ | â­â­â­â­ |
| **æ··åˆæœç´¢** | âœ… | âœ… | âš ï¸ | âœ… |
| **æˆæœ¬** | ä½ï¼ˆè‡ªéƒ¨ç½²ï¼‰| é«˜ï¼ˆæŒ‰é‡ä»˜è´¹ï¼‰| ä½ | ä½ |
| **æ–‡æ¡£** | å®Œå–„ | å®Œå–„ | ä¸€èˆ¬ | è¾ƒå¥½ |
| **ç¤¾åŒº** | æ´»è·ƒ | å•†ä¸šæ”¯æŒ | æ´»è·ƒ | æ´»è·ƒ |

#### æ ¸å¿ƒä¼˜åŠ¿

**1. é«˜æ€§èƒ½è¿‡æ»¤**
```python
# Qdrant æ”¯æŒå¤æ‚çš„è¿‡æ»¤æ¡ä»¶
results = qdrant_client.search(
    collection_name="code_embeddings",
    query_vector=embedding,
    query_filter={
        "must": [
            {"key": "language", "match": {"value": "python"}},
            {"key": "file_path", "match": {"text": "auth"}}
        ],
        "should": [
            {"key": "symbols", "match": {"any": ["login", "authenticate"]}}
        ]
    },
    limit=10
)
```

**2. Payload ç´¢å¼•**
```python
# å¯ä»¥å¯¹ payload å­—æ®µå»ºç«‹ç´¢å¼•
qdrant_client.create_payload_index(
    collection_name="code_embeddings",
    field_name="language",
    field_schema="keyword"
)
# è¿‡æ»¤æŸ¥è¯¢é€Ÿåº¦æå‡ 100x
```

**3. æ··åˆæœç´¢**
```python
# å‘é‡æœç´¢ + å…¨æ–‡æœç´¢
results = qdrant_client.search(
    collection_name="code_embeddings",
    query_vector=embedding,
    query_filter={
        "must": [
            {"key": "code", "match": {"text": "fibonacci"}}
        ]
    }
)
```

#### é€‰æ‹©ç†ç”±

âœ… **å¼€æºå…è´¹** - å¯è‡ªéƒ¨ç½²ï¼Œæ— ä½¿ç”¨é™åˆ¶
âœ… **é«˜æ€§èƒ½** - Rust å®ç°ï¼Œé€Ÿåº¦å¿«
âœ… **è¿‡æ»¤å¼ºå¤§** - æ”¯æŒå¤æ‚è¿‡æ»¤æ¡ä»¶
âœ… **æ˜“äºéƒ¨ç½²** - Docker ä¸€é”®éƒ¨ç½²
âœ… **æ–‡æ¡£å®Œå–„** - è¯¦ç»†çš„ä½¿ç”¨æŒ‡å—

#### æ›¿ä»£æ–¹æ¡ˆ

**Pinecone**:
- ä¼˜ç‚¹: æ‰˜ç®¡æœåŠ¡ï¼Œæ— éœ€è¿ç»´
- ç¼ºç‚¹: é—­æºã€æŒ‰é‡ä»˜è´¹ã€æˆæœ¬é«˜
- é€‚ç”¨: ä¸æƒ³è‡ªå·±è¿ç»´

**Milvus**:
- ä¼˜ç‚¹: æ€§èƒ½æé«˜ã€åŠŸèƒ½ä¸°å¯Œ
- ç¼ºç‚¹: éƒ¨ç½²å¤æ‚ã€å­¦ä¹ æ›²çº¿é™¡
- é€‚ç”¨: å¤§è§„æ¨¡éƒ¨ç½²

**Weaviate**:
- ä¼˜ç‚¹: GraphQL APIã€æ¨¡å—åŒ–
- ç¼ºç‚¹: è¿‡æ»¤åŠŸèƒ½ç›¸å¯¹å¼±
- é€‚ç”¨: éœ€è¦ GraphQL æ¥å£

---

### 5. ç¼“å­˜ï¼šRedis

#### å¯¹æ¯”åˆ†æ

| ç‰¹æ€§ | Redis | Memcached | å†…å­˜ç¼“å­˜ |
|------|-------|-----------|---------|
| **æ€§èƒ½** | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ |
| **æ•°æ®ç»“æ„** | ä¸°å¯Œ | ç®€å• | è‡ªå®šä¹‰ |
| **æŒä¹…åŒ–** | âœ… | âŒ | âŒ |
| **åˆ†å¸ƒå¼** | âœ… | âœ… | âŒ |
| **åŠŸèƒ½** | ä¸°å¯Œ | ç®€å• | åŸºç¡€ |

#### æ ¸å¿ƒä¼˜åŠ¿

**1. ä¸°å¯Œçš„æ•°æ®ç»“æ„**
```python
# String - ç®€å•ç¼“å­˜
redis.set("key", "value", ex=3600)

# Hash - å¯¹è±¡ç¼“å­˜
redis.hset("user:123", mapping={
    "name": "John",
    "email": "john@example.com"
})

# List - é˜Ÿåˆ—
redis.lpush("task_queue", task_data)

# Set - å»é‡
redis.sadd("processed_files", file_path)

# Sorted Set - æ’è¡Œæ¦œ
redis.zadd("leaderboard", {user_id: score})
```

**2. æŒä¹…åŒ–**
```python
# RDB - å¿«ç…§
# å®šæœŸä¿å­˜å†…å­˜æ•°æ®åˆ°ç£ç›˜

# AOF - è¿½åŠ æ—¥å¿—
# è®°å½•æ¯ä¸ªå†™æ“ä½œï¼Œé‡å¯æ—¶é‡æ”¾
```

**3. åˆ†å¸ƒå¼é”**
```python
# ä½¿ç”¨ Redis å®ç°åˆ†å¸ƒå¼é”
lock = redis.set(
    "lock:model_loading",
    "server_1",
    nx=True,  # åªåœ¨ä¸å­˜åœ¨æ—¶è®¾ç½®
    ex=30     # 30 ç§’è¿‡æœŸ
)
if lock:
    # è·å¾—é”ï¼Œæ‰§è¡Œæ“ä½œ
    load_model()
    redis.delete("lock:model_loading")
```

#### é€‰æ‹©ç†ç”±

âœ… **åŠŸèƒ½ä¸°å¯Œ** - ä¸ä»…æ˜¯ç¼“å­˜ï¼Œè¿˜æ˜¯æ•°æ®ç»“æ„æœåŠ¡å™¨
âœ… **é«˜æ€§èƒ½** - å•çº¿ç¨‹ä½†æå¿«
âœ… **æŒä¹…åŒ–** - æ•°æ®ä¸ä¼šä¸¢å¤±
âœ… **æˆç†Ÿç¨³å®š** - ç»è¿‡å¤§è§„æ¨¡éªŒè¯
âœ… **ç”Ÿæ€å®Œå–„** - å·¥å…·å’Œåº“ä¸°å¯Œ

#### æ›¿ä»£æ–¹æ¡ˆ

**Memcached**:
- ä¼˜ç‚¹: æ›´ç®€å•ã€å¤šçº¿ç¨‹
- ç¼ºç‚¹: åŠŸèƒ½å•ä¸€ã€æ— æŒä¹…åŒ–
- é€‚ç”¨: çº¯ç¼“å­˜åœºæ™¯

**å†…å­˜ç¼“å­˜**:
- ä¼˜ç‚¹: æœ€å¿«ã€æ— ç½‘ç»œå¼€é”€
- ç¼ºç‚¹: æ— æ³•è·¨è¿›ç¨‹å…±äº«
- é€‚ç”¨: å•æœºéƒ¨ç½²

---

### 6. æ•°æ®åº“ï¼šPostgreSQL

#### å¯¹æ¯”åˆ†æ

| ç‰¹æ€§ | PostgreSQL | MySQL | MongoDB |
|------|-----------|-------|---------|
| **ACID** | â­â­â­â­â­ | â­â­â­â­ | â­â­â­ |
| **JSON æ”¯æŒ** | â­â­â­â­â­ | â­â­â­ | â­â­â­â­â­ |
| **å…¨æ–‡æœç´¢** | âœ… | âš ï¸ æœ‰é™ | âœ… |
| **æ‰©å±•æ€§** | â­â­â­â­â­ | â­â­â­ | â­â­â­â­ |
| **æ€§èƒ½** | â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­ |
| **ç¤¾åŒº** | éå¸¸æ´»è·ƒ | éå¸¸æ´»è·ƒ | æ´»è·ƒ |

#### æ ¸å¿ƒä¼˜åŠ¿

**1. JSONB æ”¯æŒ**
```sql
-- å­˜å‚¨ JSON æ•°æ®
CREATE TABLE tool_calls (
    id UUID PRIMARY KEY,
    tool_name VARCHAR(100),
    arguments JSONB,  -- é«˜æ•ˆçš„ JSON å­˜å‚¨
    result JSONB
);

-- æŸ¥è¯¢ JSON å­—æ®µ
SELECT * FROM tool_calls
WHERE arguments->>'query' = 'fibonacci';

-- JSON ç´¢å¼•
CREATE INDEX idx_arguments_query
ON tool_calls ((arguments->>'query'));
```

**2. ä¸°å¯Œçš„æ•°æ®ç±»å‹**
```sql
-- UUID
id UUID DEFAULT gen_random_uuid()

-- æ•°ç»„
tags TEXT[]

-- èŒƒå›´
price_range INT4RANGE

-- å‡ ä½•ç±»å‹
location POINT
```

**3. å¼ºå¤§çš„æ‰©å±•**
```sql
-- å…¨æ–‡æœç´¢
CREATE INDEX idx_code_fts
ON code_snippets
USING gin(to_tsvector('english', code));

-- å‘é‡æ‰©å±•ï¼ˆpgvectorï¼‰
CREATE EXTENSION vector;
CREATE TABLE embeddings (
    id SERIAL PRIMARY KEY,
    embedding vector(768)
);
```

#### é€‰æ‹©ç†ç”±

âœ… **åŠŸèƒ½å¼ºå¤§** - æœ€æ¥è¿‘ SQL æ ‡å‡†
âœ… **JSONB** - çµæ´»å­˜å‚¨ç»“æ„åŒ–æ•°æ®
âœ… **æ‰©å±•ä¸°å¯Œ** - å¯ä»¥æ·»åŠ å„ç§åŠŸèƒ½
âœ… **ACID å®Œæ•´** - æ•°æ®ä¸€è‡´æ€§ä¿è¯
âœ… **å¼€æºå…è´¹** - æ— è®¸å¯è¯é™åˆ¶

#### æ›¿ä»£æ–¹æ¡ˆ

**MySQL**:
- ä¼˜ç‚¹: æ€§èƒ½ç•¥é«˜ã€æ›´æµè¡Œ
- ç¼ºç‚¹: åŠŸèƒ½ç›¸å¯¹å°‘
- é€‚ç”¨: ç®€å•çš„ CRUD åº”ç”¨

**MongoDB**:
- ä¼˜ç‚¹: Schema-lessã€æ°´å¹³æ‰©å±•å¥½
- ç¼ºç‚¹: æ— äº‹åŠ¡ï¼ˆæ—§ç‰ˆæœ¬ï¼‰
- é€‚ç”¨: æ–‡æ¡£å‹æ•°æ®

---

### 7. ä»»åŠ¡é˜Ÿåˆ—ï¼šCelery

#### å¯¹æ¯”åˆ†æ

| ç‰¹æ€§ | Celery | RQ | Dramatiq |
|------|--------|----|---------|
| **åŠŸèƒ½** | â­â­â­â­â­ | â­â­â­ | â­â­â­â­ |
| **æ€§èƒ½** | â­â­â­â­ | â­â­â­â­ | â­â­â­â­â­ |
| **æ˜“ç”¨æ€§** | â­â­â­ | â­â­â­â­â­ | â­â­â­â­ |
| **ç›‘æ§** | âœ… Flower | âš ï¸ ç®€å• | âœ… å†…ç½® |
| **è°ƒåº¦** | âœ… Beat | âŒ | âœ… |
| **ç¤¾åŒº** | éå¸¸æ´»è·ƒ | æ´»è·ƒ | æ´»è·ƒ |

#### æ ¸å¿ƒä¼˜åŠ¿

**1. åŠŸèƒ½å®Œæ•´**
```python
from celery import Celery

app = Celery('vlinders', broker='redis://localhost')

# å¼‚æ­¥ä»»åŠ¡
@app.task
def compress_context(context_id):
    # åå°å‹ç¼©å¯¹è¯å†å²
    pass

# å®šæ—¶ä»»åŠ¡
@app.task
def cleanup_old_logs():
    # æ¸…ç†æ—§æ—¥å¿—
    pass

app.conf.beat_schedule = {
    'cleanup-every-day': {
        'task': 'cleanup_old_logs',
        'schedule': crontab(hour=0, minute=0)
    }
}
```

**2. ç›‘æ§å·¥å…·**
```bash
# Flower - Web ç›‘æ§ç•Œé¢
celery -A vlinders flower

# æŸ¥çœ‹ä»»åŠ¡çŠ¶æ€ã€worker çŠ¶æ€ã€ç»Ÿè®¡ä¿¡æ¯
```

**3. çµæ´»çš„è·¯ç”±**
```python
# ä¸åŒä»»åŠ¡è·¯ç”±åˆ°ä¸åŒé˜Ÿåˆ—
app.conf.task_routes = {
    'compress_context': {'queue': 'background'},
    'generate_embedding': {'queue': 'gpu'},
    'send_email': {'queue': 'io'}
}
```

#### é€‰æ‹©ç†ç”±

âœ… **åŠŸèƒ½æœ€å…¨** - æ”¯æŒå®šæ—¶ã€é“¾å¼ã€åˆ†ç»„ç­‰
âœ… **ç›‘æ§å®Œå–„** - Flower æä¾›å¯è§†åŒ–
âœ… **æˆç†Ÿç¨³å®š** - ç»è¿‡å¤§è§„æ¨¡éªŒè¯
âœ… **ç”Ÿæ€ä¸°å¯Œ** - æ’ä»¶å’Œå·¥å…·å¤š

#### æ›¿ä»£æ–¹æ¡ˆ

**RQ (Redis Queue)**:
- ä¼˜ç‚¹: ç®€å•ã€æ˜“ç”¨
- ç¼ºç‚¹: åŠŸèƒ½ç›¸å¯¹å°‘
- é€‚ç”¨: ç®€å•çš„åå°ä»»åŠ¡

**Dramatiq**:
- ä¼˜ç‚¹: æ€§èƒ½å¥½ã€ç°ä»£åŒ–
- ç¼ºç‚¹: ç¤¾åŒºç›¸å¯¹å°
- é€‚ç”¨: è¿½æ±‚æ€§èƒ½

---

### 8. ç›‘æ§ï¼šPrometheus + Grafana

#### å¯¹æ¯”åˆ†æ

| ç‰¹æ€§ | Prometheus | InfluxDB | Datadog |
|------|-----------|----------|---------|
| **å¼€æº** | âœ… | âœ… | âŒ |
| **æ€§èƒ½** | â­â­â­â­â­ | â­â­â­â­ | â­â­â­â­â­ |
| **æŸ¥è¯¢** | PromQL | InfluxQL | ä¸“æœ‰ |
| **å¯è§†åŒ–** | Grafana | å†…ç½® | å†…ç½® |
| **å‘Šè­¦** | âœ… | âœ… | âœ… |
| **æˆæœ¬** | å…è´¹ | å…è´¹/ä»˜è´¹ | ä»˜è´¹ |

#### æ ¸å¿ƒä¼˜åŠ¿

**1. å¼ºå¤§çš„æŸ¥è¯¢è¯­è¨€**
```promql
# å¹³å‡å“åº”æ—¶é—´
rate(vlinders_response_seconds_sum[5m])
/ rate(vlinders_response_seconds_count[5m])

# GPU ä½¿ç”¨ç‡
avg(vlinders_gpu_utilization) by (gpu_id)

# é”™è¯¯ç‡
rate(vlinders_requests_total{status="error"}[5m])
/ rate(vlinders_requests_total[5m])
```

**2. è‡ªåŠ¨æœåŠ¡å‘ç°**
```yaml
# prometheus.yml
scrape_configs:
  - job_name: 'vlinders-server'
    kubernetes_sd_configs:
      - role: pod
    relabel_configs:
      - source_labels: [__meta_kubernetes_pod_label_app]
        regex: vlinders-server
        action: keep
```

**3. å‘Šè­¦è§„åˆ™**
```yaml
# alerts.yml
groups:
  - name: vlinders
    rules:
      - alert: HighErrorRate
        expr: rate(vlinders_requests_total{status="error"}[5m]) > 0.05
        for: 5m
        annotations:
          summary: "Error rate > 5%"

      - alert: HighGPUMemory
        expr: vlinders_gpu_memory_used / vlinders_gpu_memory_total > 0.9
        for: 10m
        annotations:
          summary: "GPU memory > 90%"
```

#### é€‰æ‹©ç†ç”±

âœ… **å¼€æºå…è´¹** - æ— ä½¿ç”¨é™åˆ¶
âœ… **æ€§èƒ½ä¼˜ç§€** - æ—¶åºæ•°æ®åº“ä¼˜åŒ–
âœ… **ç”Ÿæ€å®Œå–„** - Grafana å¯è§†åŒ–å¼ºå¤§
âœ… **äº‘åŸç”Ÿ** - Kubernetes é›†æˆå¥½
âœ… **ç¤¾åŒºæ´»è·ƒ** - CNCF é¡¹ç›®

#### æ›¿ä»£æ–¹æ¡ˆ

**Datadog**:
- ä¼˜ç‚¹: åŠŸèƒ½æœ€å…¨ã€SaaS æœåŠ¡
- ç¼ºç‚¹: æ˜‚è´µ
- é€‚ç”¨: é¢„ç®—å……è¶³çš„ä¼ä¸š

**InfluxDB**:
- ä¼˜ç‚¹: æ—¶åºæ•°æ®åº“ä¸“ç”¨
- ç¼ºç‚¹: æŸ¥è¯¢è¯­è¨€ä¸å¦‚ PromQL
- é€‚ç”¨: éœ€è¦é•¿æœŸå­˜å‚¨

---

## ğŸ“Š æŠ€æœ¯æ ˆæ€»è§ˆ

### å®Œæ•´æŠ€æœ¯æ ˆ

```yaml
è¯­è¨€:
  - Python 3.11+

æ¨ç†:
  - vLLM (å¤§æ¨¡å‹æ¨ç†)
  - vLLM Semantic Router (æ™ºèƒ½æ¨¡å‹è·¯ç”±)
  - CUDA 12.0+
  - cuDNN 8.9+

Web æ¡†æ¶:
  - FastAPI (HTTP API)
  - gRPC (å†…éƒ¨é€šä¿¡)
  - Uvicorn (ASGI æœåŠ¡å™¨)

ä»£ç åˆ†æ:
  - Tree-sitter (è¯­æ³•è§£æ)
  - Pygments (è¯­æ³•é«˜äº®)
  - rope (é‡æ„å·¥å…·)

å‘é‡æœç´¢:
  - Qdrant (å‘é‡æ•°æ®åº“)
  - sentence-transformers (åµŒå…¥ç”Ÿæˆ)

æ•°æ®å­˜å‚¨:
  - PostgreSQL (å…³ç³»æ•°æ®)
  - Redis (ç¼“å­˜ã€é˜Ÿåˆ—)
  - Qdrant (å‘é‡æ•°æ®)

ä»»åŠ¡é˜Ÿåˆ—:
  - Celery (å¼‚æ­¥ä»»åŠ¡)
  - Redis (æ¶ˆæ¯ä»£ç†)

ç›‘æ§:
  - Prometheus (æŒ‡æ ‡æ”¶é›†)
  - Grafana (å¯è§†åŒ–)
  - OpenTelemetry (è¿½è¸ª)
  - Sentry (é”™è¯¯è¿½è¸ª)

éƒ¨ç½²:
  - Docker (å®¹å™¨åŒ–)
  - Kubernetes (ç¼–æ’)
  - Nginx (åå‘ä»£ç†)

å¼€å‘å·¥å…·:
  - Poetry (ä¾èµ–ç®¡ç†)
  - Black (ä»£ç æ ¼å¼åŒ–)
  - Ruff (Linter)
  - pytest (æµ‹è¯•)
  - mypy (ç±»å‹æ£€æŸ¥)
```

---

## ğŸ¯ æ€»ç»“

### é€‰å‹å†³ç­–çŸ©é˜µ

| ç»„ä»¶ | é€‰æ‹© | æ ¸å¿ƒç†ç”± |
|------|------|---------|
| **æ¨ç†å¼•æ“** | vLLM | æ€§èƒ½æœ€ä¼˜ï¼ˆ24xï¼‰ã€æ˜“ç”¨ |
| **æ¨¡å‹è·¯ç”±** | vLLM Semantic Router | æˆæœ¬ä¼˜åŒ–ã€æ™ºèƒ½é€‰æ‹© |
| **Web æ¡†æ¶** | FastAPI | å¼‚æ­¥ã€ç±»å‹å®‰å…¨ã€è‡ªåŠ¨æ–‡æ¡£ |
| **ä»£ç è§£æ** | Tree-sitter | é«˜æ€§èƒ½ã€å¤šè¯­è¨€ã€å¢é‡è§£æ |
| **å‘é‡æ•°æ®åº“** | Qdrant | å¼€æºã€é«˜æ€§èƒ½ã€è¿‡æ»¤å¼ºå¤§ |
| **ç¼“å­˜** | Redis | åŠŸèƒ½ä¸°å¯Œã€æŒä¹…åŒ–ã€åˆ†å¸ƒå¼ |
| **æ•°æ®åº“** | PostgreSQL | JSONBã€æ‰©å±•ä¸°å¯Œã€ACID |
| **ä»»åŠ¡é˜Ÿåˆ—** | Celery | åŠŸèƒ½å®Œæ•´ã€ç›‘æ§å¥½ã€æˆç†Ÿ |
| **ç›‘æ§** | Prometheus | å¼€æºã€PromQL å¼ºå¤§ã€ç”Ÿæ€å¥½ |

### å…³é”®åŸåˆ™

1. **æ€§èƒ½ä¼˜å…ˆ** - é€‰æ‹©æœ€é«˜æ€§èƒ½çš„æ–¹æ¡ˆï¼ˆvLLMã€Redisï¼‰
2. **æˆæœ¬ä¼˜åŒ–** - æ™ºèƒ½è·¯ç”±é™ä½æ¨ç†æˆæœ¬ï¼ˆSemantic Routerï¼‰
3. **å¼€æºä¼˜å…ˆ** - é¿å…ä¾›åº”å•†é”å®šï¼ˆQdrant vs Pineconeï¼‰
4. **æˆç†Ÿç¨³å®š** - é€‰æ‹©ç»è¿‡éªŒè¯çš„æŠ€æœ¯ï¼ˆPostgreSQLã€Redisï¼‰
5. **æ˜“äºç»´æŠ¤** - é™ä½é•¿æœŸæˆæœ¬ï¼ˆFastAPIã€Dockerï¼‰
6. **ç¤¾åŒºæ´»è·ƒ** - ç¡®ä¿æŒç»­æ”¯æŒï¼ˆæ‰€æœ‰é€‰æ‹©ï¼‰

---

**ä¸‹ä¸€æ­¥**: é˜…è¯» [03-vLLMé›†æˆæ–¹æ¡ˆ.md](./03-vLLMé›†æˆæ–¹æ¡ˆ.md)
