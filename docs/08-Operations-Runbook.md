# éƒ¨ç½²æ£€æŸ¥æ¸…å•å’Œè¿ç»´æ‰‹å†Œ

**ç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¥æœŸ**: 2026-02-28
**çŠ¶æ€**: ğŸ“ è®¾è®¡é˜¶æ®µ

---

## ğŸ“‹ éƒ¨ç½²å‰æ£€æŸ¥æ¸…å•

### åŸºç¡€è®¾æ–½å‡†å¤‡

#### Kubernetes é›†ç¾¤
- [ ] Kubernetes 1.28+ é›†ç¾¤å·²åˆ›å»º
- [ ] kubectl é…ç½®æ­£ç¡®ï¼Œå¯ä»¥è®¿é—®é›†ç¾¤
- [ ] é›†ç¾¤æœ‰è¶³å¤Ÿçš„èµ„æºï¼ˆCPUã€å†…å­˜ã€å­˜å‚¨ï¼‰
- [ ] GPU èŠ‚ç‚¹å·²é…ç½®å¹¶å¯ç”¨
- [ ] NVIDIA GPU Operator å·²å®‰è£…
- [ ] ç½‘ç»œæ’ä»¶å·²é…ç½®ï¼ˆCalico/Ciliumï¼‰
- [ ] å­˜å‚¨ç±»å·²é…ç½®ï¼ˆgp3/fast-ssdï¼‰

#### åŸŸåå’Œè¯ä¹¦
- [ ] åŸŸåå·²æ³¨å†Œï¼ˆapi.vlinders.comï¼‰
- [ ] DNS è®°å½•å·²é…ç½®
- [ ] SSL è¯ä¹¦å·²ç”³è¯·ï¼ˆLet's Encrypt/å•†ä¸šè¯ä¹¦ï¼‰
- [ ] è¯ä¹¦å·²å¯¼å…¥ Kubernetes Secrets

#### å¤–éƒ¨æœåŠ¡
- [ ] Stripe è´¦æˆ·å·²åˆ›å»º
- [ ] Stripe API å¯†é’¥å·²è·å–
- [ ] Stripe Webhook å·²é…ç½®
- [ ] S3/å¯¹è±¡å­˜å‚¨å·²é…ç½®
- [ ] é‚®ä»¶æœåŠ¡å·²é…ç½®ï¼ˆSendGrid/SESï¼‰

---

### é…ç½®æ–‡ä»¶å‡†å¤‡

#### Secrets
- [ ] JWT å¯†é’¥å¯¹å·²ç”Ÿæˆï¼ˆRS256ï¼‰
- [ ] æ•°æ®åº“å¯†ç å·²ç”Ÿæˆï¼ˆå¼ºå¯†ç ï¼‰
- [ ] Internal Secret å·²ç”Ÿæˆ
- [ ] Stripe å¯†é’¥å·²é…ç½®
- [ ] æ‰€æœ‰ Secrets å·²åˆ›å»ºåœ¨ Kubernetes

#### ConfigMaps
- [ ] æœåŠ¡å™¨é…ç½®å·²å‡†å¤‡
- [ ] æ¨¡å‹é…ç½®å·²å‡†å¤‡
- [ ] æ—¥å¿—é…ç½®å·²å‡†å¤‡

---

### æ•°æ®åº“å‡†å¤‡

#### PostgreSQL
- [ ] æ•°æ®åº“å®ä¾‹å·²åˆ›å»º
- [ ] æ•°æ®åº“ç”¨æˆ·å·²åˆ›å»º
- [ ] åˆå§‹åŒ–è„šæœ¬å·²å‡†å¤‡
- [ ] å¤‡ä»½ç­–ç•¥å·²é…ç½®
- [ ] è¿æ¥æµ‹è¯•é€šè¿‡

#### Redis
- [ ] Redis é›†ç¾¤å·²éƒ¨ç½²
- [ ] æŒä¹…åŒ–å·²é…ç½®
- [ ] è¿æ¥æµ‹è¯•é€šè¿‡

#### Qdrant
- [ ] Qdrant å®ä¾‹å·²éƒ¨ç½²
- [ ] Collection å·²åˆ›å»º
- [ ] è¿æ¥æµ‹è¯•é€šè¿‡

---

### æ¨¡å‹å‡†å¤‡

#### æ¨¡å‹æ–‡ä»¶
- [ ] æ¨¡å‹å·²ä¸‹è½½åˆ°æœ¬åœ°
- [ ] æ¨¡å‹æ–‡ä»¶å®Œæ•´æ€§å·²éªŒè¯
- [ ] æ¨¡å‹å·²ä¸Šä¼ åˆ°æŒä¹…åŒ–å­˜å‚¨
- [ ] PVC å·²åˆ›å»ºå¹¶æŒ‚è½½
- [ ] æ¨¡å‹åŠ è½½æµ‹è¯•é€šè¿‡

---

### ç›‘æ§å‡†å¤‡

#### Prometheus
- [ ] Prometheus å·²éƒ¨ç½²
- [ ] æŠ“å–é…ç½®å·²è®¾ç½®
- [ ] å­˜å‚¨å·²é…ç½®
- [ ] å‘Šè­¦è§„åˆ™å·²é…ç½®

#### Grafana
- [ ] Grafana å·²éƒ¨ç½²
- [ ] æ•°æ®æºå·²é…ç½®
- [ ] ä»ªè¡¨æ¿å·²å¯¼å…¥
- [ ] å‘Šè­¦é€šçŸ¥å·²é…ç½®ï¼ˆSlack/PagerDutyï¼‰

#### Loki
- [ ] Loki å·²éƒ¨ç½²
- [ ] Promtail å·²é…ç½®
- [ ] æ—¥å¿—ä¿ç•™ç­–ç•¥å·²è®¾ç½®

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### Phase 1: åŸºç¡€è®¾æ–½éƒ¨ç½²

```bash
# 1. åˆ›å»ºå‘½åç©ºé—´
kubectl apply -f k8s/namespaces.yaml

# 2. åˆ›å»º Secrets
kubectl create secret generic vlinders-secrets \
  --from-literal=postgres-password=<password> \
  --from-literal=internal-secret=<secret> \
  --from-literal=stripe-secret-key=<key> \
  -n vlinders-platform

# 3. åˆ›å»º ConfigMaps
kubectl apply -f k8s/configmap.yaml

# 4. åˆ›å»ºå­˜å‚¨
kubectl apply -f k8s/storage.yaml

# 5. ç­‰å¾… PVC ç»‘å®š
kubectl get pvc -n vlinders-platform -w
```

### Phase 2: æ•°æ®åº“éƒ¨ç½²

```bash
# 1. éƒ¨ç½² PostgreSQL
kubectl apply -f k8s/postgres.yaml

# 2. ç­‰å¾… PostgreSQL å°±ç»ª
kubectl wait --for=condition=ready pod \
  -l app=postgres \
  -n vlinders-platform \
  --timeout=300s

# 3. åˆå§‹åŒ–æ•°æ®åº“
kubectl exec -it postgres-0 -n vlinders-platform -- \
  psql -U vlinders -d vlinders -f /init/01_init.sql

# 4. éªŒè¯æ•°æ®åº“
kubectl exec -it postgres-0 -n vlinders-platform -- \
  psql -U vlinders -d vlinders -c "\dt"

# 5. éƒ¨ç½² Redis
kubectl apply -f k8s/redis.yaml

# 6. ç­‰å¾… Redis å°±ç»ª
kubectl wait --for=condition=ready pod \
  -l app=redis \
  -n vlinders-platform \
  --timeout=300s
```

### Phase 3: æ¨ç†æœåŠ¡éƒ¨ç½²

```bash
# 1. éƒ¨ç½² Ray Cluster
kubectl apply -f k8s/ray-cluster.yaml

# 2. ç­‰å¾… Ray Head å°±ç»ª
kubectl wait --for=condition=ready pod \
  -l ray.io/node-type=head \
  -n vlinders-inference \
  --timeout=600s

# 3. æ£€æŸ¥ Ray Dashboard
kubectl port-forward -n vlinders-inference \
  svc/ray-head 8265:8265

# è®¿é—® http://localhost:8265

# 4. éƒ¨ç½²æ¨ç†æœåŠ¡
ray job submit --address http://localhost:8265 \
  --working-dir ./ray-serve \
  -- python serve_config.py

# 5. éªŒè¯æ¨ç†æœåŠ¡
curl http://localhost:8000/v1/models
```

### Phase 4: API Gateway éƒ¨ç½²

```bash
# 1. éƒ¨ç½² Kong Gateway
kubectl apply -f k8s/kong-gateway.yaml

# 2. ç­‰å¾… Kong å°±ç»ª
kubectl wait --for=condition=ready pod \
  -l app=kong-gateway \
  -n vlinders-platform \
  --timeout=300s

# 3. è·å– LoadBalancer IP
kubectl get svc kong-gateway -n vlinders-platform

# 4. é…ç½® DNS
# å°†åŸŸåæŒ‡å‘ LoadBalancer IP

# 5. æµ‹è¯• API
curl https://api.vlinders.com/v1/models
```

### Phase 5: ç›‘æ§éƒ¨ç½²

```bash
# 1. éƒ¨ç½² Prometheus
helm install prometheus prometheus-community/prometheus \
  -n vlinders-monitoring \
  -f k8s/prometheus-values.yaml

# 2. éƒ¨ç½² Grafana
helm install grafana grafana/grafana \
  -n vlinders-monitoring \
  -f k8s/grafana-values.yaml

# 3. è·å– Grafana å¯†ç 
kubectl get secret grafana -n vlinders-monitoring \
  -o jsonpath="{.data.admin-password}" | base64 --decode

# 4. è®¿é—® Grafana
kubectl port-forward -n vlinders-monitoring \
  svc/grafana 3000:80

# 5. å¯¼å…¥ä»ªè¡¨æ¿
# è®¿é—® http://localhost:3000
# å¯¼å…¥ k8s/grafana-dashboards/*.json
```

---

## âœ… éƒ¨ç½²åéªŒè¯

### å¥åº·æ£€æŸ¥

```bash
# 1. æ£€æŸ¥æ‰€æœ‰ Pods
kubectl get pods --all-namespaces

# 2. æ£€æŸ¥æœåŠ¡çŠ¶æ€
kubectl get svc --all-namespaces

# 3. æ£€æŸ¥ PVC
kubectl get pvc --all-namespaces

# 4. æ£€æŸ¥ GPU èŠ‚ç‚¹
kubectl get nodes -l nvidia.com/gpu=true
```

### åŠŸèƒ½æµ‹è¯•

```bash
# 1. æµ‹è¯•ç”¨æˆ·æ³¨å†Œ
curl -X POST https://api.vlinders.com/v1/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "password": "Test123!",
    "full_name": "Test User",
    "tenant_name": "Test Tenant"
  }'

# 2. æµ‹è¯•ç”¨æˆ·ç™»å½•
curl -X POST https://api.vlinders.com/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "password": "Test123!"
  }'

# 3. æµ‹è¯•æ¨ç†
curl -X POST https://api.vlinders.com/v1/chat/completions \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <token>" \
  -d '{
    "model": "gpt-4",
    "messages": [
      {"role": "user", "content": "Hello"}
    ]
  }'
```

### æ€§èƒ½æµ‹è¯•

```bash
# 1. å®‰è£… k6
brew install k6  # macOS
# æˆ–
sudo apt install k6  # Ubuntu

# 2. è¿è¡Œè´Ÿè½½æµ‹è¯•
k6 run tests/load-test.js

# 3. æ£€æŸ¥ç»“æœ
# - P95 å»¶è¿Ÿ < 500ms
# - é”™è¯¯ç‡ < 1%
# - ååé‡ > 1000 req/s
```

---

## ğŸ”§ æ—¥å¸¸è¿ç»´

### ç›‘æ§æ£€æŸ¥

#### æ¯æ—¥æ£€æŸ¥
```bash
# 1. æ£€æŸ¥é›†ç¾¤å¥åº·
kubectl get nodes
kubectl top nodes

# 2. æ£€æŸ¥ Pod çŠ¶æ€
kubectl get pods --all-namespaces | grep -v Running

# 3. æ£€æŸ¥æœ€è¿‘çš„é”™è¯¯æ—¥å¿—
kubectl logs -n vlinders-platform \
  -l app=vlinders-api \
  --since=24h | grep ERROR

# 4. æ£€æŸ¥ GPU ä½¿ç”¨ç‡
kubectl exec -it <ray-worker-pod> -n vlinders-inference -- \
  nvidia-smi
```

#### æ¯å‘¨æ£€æŸ¥
- [ ] æ£€æŸ¥ç£ç›˜ä½¿ç”¨ç‡
- [ ] æ£€æŸ¥æ•°æ®åº“æ€§èƒ½
- [ ] æ£€æŸ¥å¤‡ä»½çŠ¶æ€
- [ ] å®¡æŸ¥å‘Šè­¦å†å²
- [ ] æ£€æŸ¥æˆæœ¬ä½¿ç”¨

#### æ¯æœˆæ£€æŸ¥
- [ ] å®‰å…¨è¡¥ä¸æ›´æ–°
- [ ] è¯ä¹¦è¿‡æœŸæ£€æŸ¥
- [ ] å®¹é‡è§„åˆ’è¯„ä¼°
- [ ] æ€§èƒ½è¶‹åŠ¿åˆ†æ
- [ ] ç¾éš¾æ¢å¤æ¼”ç»ƒ

---

### å¸¸è§è¿ç»´ä»»åŠ¡

#### æ‰©å®¹ GPU èŠ‚ç‚¹

```bash
# 1. å¢åŠ  Ray Worker å‰¯æœ¬æ•°
kubectl scale raycluster vlinders-ray-cluster \
  --replicas=5 \
  -n vlinders-inference

# 2. éªŒè¯æ–°èŠ‚ç‚¹
kubectl get pods -n vlinders-inference \
  -l ray.io/node-type=worker
```

#### æ›´æ–°æ¨¡å‹

```bash
# 1. ä¸‹è½½æ–°æ¨¡å‹
python scripts/download_model.py \
  --model meta-llama/Llama-3.1-70B \
  --output /models/llama-3.1-70b

# 2. ä¸Šä¼ åˆ° PVC
kubectl cp /models/llama-3.1-70b \
  vlinders-inference/ray-head-0:/models/

# 3. æ›´æ–°é…ç½®
kubectl edit configmap vlinders-config \
  -n vlinders-platform

# 4. é‡å¯ Ray Serve
ray job submit --address http://ray-head:8265 \
  -- python serve_config.py
```

#### æ•°æ®åº“å¤‡ä»½

```bash
# 1. åˆ›å»ºå¤‡ä»½
kubectl exec -it postgres-0 -n vlinders-platform -- \
  pg_dump -U vlinders vlinders > backup-$(date +%Y%m%d).sql

# 2. ä¸Šä¼ åˆ° S3
aws s3 cp backup-$(date +%Y%m%d).sql \
  s3://vlinders-backups/postgres/

# 3. éªŒè¯å¤‡ä»½
aws s3 ls s3://vlinders-backups/postgres/
```

#### æ¢å¤æ•°æ®åº“

```bash
# 1. ä¸‹è½½å¤‡ä»½
aws s3 cp s3://vlinders-backups/postgres/backup-20260228.sql \
  ./backup.sql

# 2. æ¢å¤æ•°æ®åº“
kubectl exec -i postgres-0 -n vlinders-platform -- \
  psql -U vlinders vlinders < backup.sql

# 3. éªŒè¯æ¢å¤
kubectl exec -it postgres-0 -n vlinders-platform -- \
  psql -U vlinders -d vlinders -c "SELECT COUNT(*) FROM users;"
```

---

## ğŸš¨ æ•…éšœå¤„ç†

### Pod æ— æ³•å¯åŠ¨

**ç—‡çŠ¶**: Pod ä¸€ç›´å¤„äº Pending æˆ– CrashLoopBackOff çŠ¶æ€

**æ’æŸ¥æ­¥éª¤**:
```bash
# 1. æŸ¥çœ‹ Pod è¯¦æƒ…
kubectl describe pod <pod-name> -n <namespace>

# 2. æŸ¥çœ‹æ—¥å¿—
kubectl logs <pod-name> -n <namespace>

# 3. æŸ¥çœ‹äº‹ä»¶
kubectl get events -n <namespace> --sort-by='.lastTimestamp'
```

**å¸¸è§åŸå› **:
- èµ„æºä¸è¶³ï¼ˆCPU/å†…å­˜/GPUï¼‰
- é•œåƒæ‹‰å–å¤±è´¥
- é…ç½®é”™è¯¯
- å­˜å‚¨æŒ‚è½½å¤±è´¥

---

### GPU å†…å­˜ä¸è¶³

**ç—‡çŠ¶**: `CUDA out of memory` é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**:
```bash
# 1. é™ä½ GPU å†…å­˜ä½¿ç”¨ç‡
# ç¼–è¾‘ ConfigMap
kubectl edit configmap vlinders-config -n vlinders-platform

# ä¿®æ”¹ gpu_memory_utilization ä» 0.9 åˆ° 0.85

# 2. é‡å¯æœåŠ¡
kubectl rollout restart deployment <deployment-name>

# 3. æˆ–å¢åŠ  GPU æ•°é‡
# ä¿®æ”¹ tensor_parallel_size
```

---

### æ¨ç†å»¶è¿Ÿé«˜

**ç—‡çŠ¶**: P95 å»¶è¿Ÿ > 1s

**æ’æŸ¥æ­¥éª¤**:
```bash
# 1. æ£€æŸ¥ GPU åˆ©ç”¨ç‡
kubectl exec -it <ray-worker-pod> -n vlinders-inference -- \
  nvidia-smi

# 2. æ£€æŸ¥é˜Ÿåˆ—ç§¯å‹
curl http://ray-head:8265/api/serve/deployments/

# 3. æŸ¥çœ‹ Prometheus æŒ‡æ ‡
# è®¿é—® Grafana æŸ¥çœ‹å»¶è¿Ÿè¶‹åŠ¿
```

**è§£å†³æ–¹æ¡ˆ**:
- å¯ç”¨å‰ç¼€ç¼“å­˜
- å¢åŠ å‰¯æœ¬æ•°
- ä½¿ç”¨é‡åŒ–æ¨¡å‹
- ä¼˜åŒ–æ‰¹å¤„ç†å¤§å°

---

### æ•°æ®åº“è¿æ¥å¤±è´¥

**ç—‡çŠ¶**: `could not connect to server` é”™è¯¯

**æ’æŸ¥æ­¥éª¤**:
```bash
# 1. æ£€æŸ¥ PostgreSQL Pod
kubectl get pods -n vlinders-platform -l app=postgres

# 2. æ£€æŸ¥æœåŠ¡
kubectl get svc postgres -n vlinders-platform

# 3. æµ‹è¯•è¿æ¥
kubectl exec -it postgres-0 -n vlinders-platform -- \
  psql -U vlinders -d vlinders -c "SELECT 1;"

# 4. æ£€æŸ¥è¿æ¥æ•°
kubectl exec -it postgres-0 -n vlinders-platform -- \
  psql -U vlinders -d vlinders -c \
  "SELECT count(*) FROM pg_stat_activity;"
```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### GPU åˆ©ç”¨ç‡ä¼˜åŒ–

**ç›®æ ‡**: GPU åˆ©ç”¨ç‡ > 85%

**ä¼˜åŒ–æªæ–½**:
1. å¯ç”¨ Continuous Batching
2. å¢åŠ  `max_num_seqs`
3. å¯ç”¨å‰ç¼€ç¼“å­˜
4. ä½¿ç”¨é‡åŒ–æ¨¡å‹

### æˆæœ¬ä¼˜åŒ–

**ç›®æ ‡**: é™ä½ GPU æˆæœ¬ 30%

**ä¼˜åŒ–æªæ–½**:
1. é…ç½® KEDA è‡ªåŠ¨æ‰©ç¼©å®¹
2. ä½¿ç”¨ Spot å®ä¾‹
3. ä¼˜åŒ–æ¨¡å‹åŠ è½½ç­–ç•¥
4. å®æ–½è¯·æ±‚é˜Ÿåˆ—

---

## ğŸ“š å‚è€ƒæ–‡æ¡£

- [Kubernetes å®˜æ–¹æ–‡æ¡£](https://kubernetes.io/docs/)
- [Ray Serve æ–‡æ¡£](https://docs.ray.io/en/latest/serve/)
- [vLLM æ–‡æ¡£](https://docs.vllm.ai/)
- [Prometheus æ–‡æ¡£](https://prometheus.io/docs/)

---

## ğŸ“ ç´§æ€¥è”ç³»æ–¹å¼

- **è¿ç»´å›¢é˜Ÿ**: ops@vlinders.com
- **æŠ€æœ¯æ”¯æŒ**: support@vlinders.com
- **ç´§æ€¥çƒ­çº¿**: +1-xxx-xxx-xxxx
- **PagerDuty**: https://vlinders.pagerduty.com

---

**çŠ¶æ€**: ğŸ“ è®¾è®¡å®Œæˆ
**ç»´æŠ¤**: æŒç»­æ›´æ–°
